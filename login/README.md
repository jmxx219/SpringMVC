# 로그인 처리

> [상품 관리 시스템](https://github.com/jmxx219/Spring-Study/blob/main/item-service/README.md) 프로젝트에 로그인 기능을 구현해보자  
> [쿠키와 세션 설명 참고](https://github.com/jmxx219/CS-Study/blob/main/Network/%EC%BF%A0%ED%82%A4%EC%99%80%20%EC%84%B8%EC%85%98.md)

### 목차
- [쿠키](#쿠키)
- [세션](#세션)
  - [동작 방식](#동작-방식)


<br/>

### 패키지 구조 설계

**package 구조**
- hello.login 
  - domain 
    - item 
    - member 
    - login
  - web 
    - item
    - member
    - login

**도메인**

- 화면, UI, 기술 인프라 등등의 영역을 제외한 시스템이 구현해야 하는 핵심 비즈니스 업무 영역
- 향후 web을 다른 기술로 바꾸어도 도메인은 그대로 유지할 수 있어야 함
  - web은 domain을 알고있지만(의존), domain은 web을 모르도록(의존 X) 설계
  
  
---

<br/>

## 쿠키

- 로그인 상태 유지
  - 서버에서 로그인에 성공하면 HTTP 응답에 쿠키를 담아서 브라우저에 전달
  - 브라우저는 해당 쿠키를 다음 요청 때마다 지속해서 보내줌
- 종류
  - 영속 쿠키: 만료 날짜를 입력하면 해당 날짜까지 유지
  - 세션 쿠키: 만료 날짜를 생략하면 브라우저 종료시 까지만 유지
- 사용
  - 로그인 성공
    - 쿠키 생성
    ```java
    Cookie idCookie = new Cookie("memberId", String.valueOf(loginMember.getId()));
    response.addCookie(idCookie);
    ```
    - 세션 쿠키가 지속해서 유지
  - 웹 브라우저에서 서버에 요청 시 쿠키를 계속 보내줌
    - `@CookieValue`를 이용하여 편리하게 쿠키 조회 가능
  - 로그아웃 시, 서버에서 해당 쿠키의 종료 날짜를 0으로 지정하여 쿠키 종

**보안 문제**

- 쿠키 값은 임의로 변경할 수 있음
  - 클라이언트가 쿠키를 강제로 변경하면 다른 사용자가 될 수 있음
  - 실제 웹브라우저 개발자 모드 ➙ Application ➙ Cookie 변경으로 확인
- 쿠키에 보관된 정보는 훔쳐갈 수 있음
  - 쿠키에 개인정보나, 신용카드 정보 등이 있을 경우
    - 해당 정보가 웹 브라우저에도 보관되고, 네트워크 요청마다 계속 클라이언트에서 버로 전달됨
    - 쿠키의 정보가 나의 로컬 PC에서 털릴 수 도 있고, 네트워크 전송 구간에서도 털릴 수 있음
- 해커가 쿠키를 한 번 훔쳐가면 평생 사용할 수 있음
  - 해커가 쿠키를 훔쳐가 해당 쿠키로 악의적인 요청을 계속 시도할 수 있음

**대안**
- 쿠키에 중요한 값을 노출하지 않고, 사용자별로 예측 불가능한 임의의 토큰(랜덤 값)을 노출함
  - 서버에서 토큰과 사용자 id를 매핑해서 인식하고, 서버에서 토큰을 관리함
- 토큰은 해커가 임의의 값을 넣어도 찾을 수 없도록 예측 불가능해야 함
- 해커가 토큰을 털어가도 시간이 지나면 사용할 수 없도록 서버에서 토큰의 만료시간을 짧게 유지해야 함
  - 해킹이 의심되는 경우, 서버에서 해당 토큰을 강제로 제거

<br/>


## 세션

**쿠키의 보안문제**
- 쿠키에 중요한 정보를 보관하는 방법은 보안 이슈가 발생함
  - 쿠키 값 변조 가능 ➙ 예상 불가능하고 복잡한 **세션 ID**를 사용
  - 쿠키에 보관하는 정보는 클라이언트를 해킹할 시, 털릴 수 있음 ➙ 세션 ID가 털려도 해당 값에는 중요한 정보가 없음
  - 쿠키 탈취 후 사용 ➙ 해커가 토큰을 털어가도 시간이 지나면 사용할 수 없도록 서버에서 **세션의 만료시간을 짧게 유지**
  - 해킹이 의심되는 경우 서버에서 해당 **세션을 강제로 제거**할 수 있음
- 세션을 이용하여 중요한 정보를 보관하고 연결을 유지할 수 있음
  - 중요한 정보는 서버에 저장하고, 클라이언트와 서버는 추정 불가능한 임의의 식별자 값으로 연결
  

### 동작 방식

1. 로그인
   1. 사용자가 로그인 ID와 PW 정보를 전달
   2. 서버에서 해당 사용자가 맞는지 확인
2. 세션 생성
   1. 세션 ID 생성
      - 세션 ID는 추정이 불가능해야 함
      - **UUID**는 추청이 불가능함 (`Cookie: mySessionId=zz0101xx-bab9-4b92-9b32-dadb280f4b61`)
   2. 생성된 세션 ID와 세션에 보관할 값을 서버의 세션 저장소에 보관
3. 세션 ID를 응답 쿠키로 클라이언트에게 전달
   1. 서버는 클라이언트에 `mySessionId`라는 이름으로 세션 ID만 쿠키에 담아서 전달
      - 회원과 관련된 정보는 전혀 클라이언트에게 전달하지 않음
      - 오직 추정 불가능한 세션 ID만 쿠키를 통해 클라이언트에게 전달!
   2. 클라이언트는 쿠키 저장소에 `mySessionId` 쿠키를 보관함
4. 클라이언트의 세션 ID 쿠키를 서버에게 전달
   1. 요청 시, 항상 `mySessionId` 쿠키를 전달함
   2. 서버에서 클라이언트가 전달한 `mySessionId` 쿠키 정보로 세션 저장소를 조회
   3. 로그인시 보관한 세션 정보를 사용


